name: "Snyk for a new build"

on:
  pull_request_target:
    types:
      - opened
      - edited
      - synchronize
      - reopened
  workflow_call:
    secrets:
      snyk_token:
        description: 'A Snyk token passed from the caller workflow'
        required: true
jobs:
  security:
    permissions:
      contents: read         # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read          # only required for a private repository by
                             # github/codeql-action/upload-sarif to get the Action run status
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        # This is the version of the action for setting up Python, not the Python version.
        uses: actions/setup-python@v5
        with:
            # Semantic version range syntax or exact version of a Python version
            python-version: '3.x'
            # Optional - x64 or x86 architecture, defaults to x64
            architecture: 'x64'
        # You can test your matrix by printing the current Python version
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      - name: Uninstall old setuptools
        run:
          python -m pip uninstall setuptools --isolated
      - name: Install a new version of setuptools
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pip wheel
          python -m pip install setuptools
      - name: Check setuptools version
        run:
          python -m pip show setuptools
      - name: Install prerequisites
        run: |
          pip install -r requirements.txt
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python3.12@master
        env:
          token: ${{ secrets.snyk_token }}
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true # To make sure that SARIF upload gets called
        with:
          command: fix # adding this option to run snyk fix
          base: master
          args: --sarif-file-output=snyk.sarif --skip-unresolved
        # Push the Snyk Code results into GitHub Code Scanning tab
      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk.sarif